<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学图谱 - 按气质分类</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif; background: #f7f8fb; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        .header { background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }
        .logo { font-weight: bold; color: #333; text-decoration: none; font-size: 1.4rem; }
        .nav-links { display: flex; gap: 1.5rem; }
        .nav-links a { color: #333; text-decoration: none; opacity: 0.8; }
        .nav-links a:hover { opacity: 1; }

        .page-title { padding: 2rem 0 1rem; }
        .page-title h1 { font-size: 2rem; font-weight: 600; }
        .page-title p { color: #666; margin-top: .5rem; }

        .loading { text-align: center; padding: 2rem; color: #666; }
        .spinner { width: 36px; height: 36px; border: 4px solid #eee; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error { background: #fdecec; color: #d63031; padding: 1rem; border-radius: 8px; margin: 1rem 0; }

        .mood-section { margin: 1.5rem 0 2.5rem; }
        .mood-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .mood-band { width: 8px; height: 36px; border-radius: 4px; background: var(--mood-color, #667eea); }
        .mood-title { font-size: 1.3rem; font-weight: 600; }
        .mood-desc { color: #666; }

        .uni-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
        .uni-card { background: white; border-radius: 12px; border: 1px solid #eee; padding: 1rem; display: flex; gap: .8rem; align-items: center; cursor: pointer; transition: box-shadow .2s ease, transform .2s ease; }
        .uni-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.08); transform: translateY(-2px); }
        .uni-logo { width: 56px; height: 56px; border-radius: 8px; background: #fafafa; border: 1px solid #eee; object-fit: contain; }
        .uni-info { flex: 1; }
        .uni-name { font-weight: 600; }
        .uni-one { color: #666; font-size: .92rem; margin-top: .2rem; }
        .uni-like { color: #ff6b6b; font-size: .9rem; white-space: nowrap; }

        .footer { text-align: center; color: #888; font-size: .9rem; padding: 2rem 0; }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .page-title h1 { font-size: 1.6rem; }
            .uni-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="top-nav"></div>

    <section class="container page-title">
        <h1>大学图谱 · 按气质分类</h1>
        <p>浏览不同气质类型下的代表大学，点击查看详情。</p>
    </section>

    <section class="container" id="content">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>正在加载气质与大学数据...</p>
        </div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="moodWrap" style="display:none;"></div>
    </section>

    <div id="site-footer"></div>

    <script>
        const base = window.location.pathname.includes('huilanweb') ? '/huilanweb' : '';
        const apiBase = base + '/api';
        // 失效链接的大学ID（非高校内容或需删除的词条）
        const DELETED_UNIVERSITY_IDS = new Set([11, 12]);

        document.addEventListener('DOMContentLoaded', () => {
            loadMoodSections();
        });

        async function loadMoodSections() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const moodWrap = document.getElementById('moodWrap');

            try {
                const res = await fetch(apiBase + '/mood_types');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                const moods = (json && json.success && json.data && json.data.mood_types) ? json.data.mood_types : [];

                // Render sections
                moodWrap.innerHTML = moods.map(m => sectionHTML(m)).join('');

                // For each mood, load universities
                await Promise.all(moods.map(async (m) => {
                    const listEl = document.querySelector(`#mood-${m.id} .uni-grid`);
                    listEl.innerHTML = '<div class="loading" style="grid-column: 1 / -1"><div class="spinner"></div><p>加载代表大学...</p></div>';
                    try {
                        const uRes = await fetch(`${apiBase}/universities?mood_type=${encodeURIComponent(m.slug)}&per_page=8&page=1`);
                        if (!uRes.ok) throw new Error('HTTP ' + uRes.status);
                        const uJson = await uRes.json();
                        const items = Array.isArray(uJson && uJson.data) ? uJson.data : (Array.isArray(uJson) ? uJson : []);
                        const filtered = items.filter(u => {
                            const idNum = parseInt(u.id, 10);
                            return Number.isFinite(idNum) && !DELETED_UNIVERSITY_IDS.has(idNum);
                        });
                        listEl.innerHTML = filtered.length
                            ? filtered.map(u => universityCardHTML(u)).join('')
                            : '<div class="error" style="grid-column: 1 / -1">暂无代表大学</div>';

                        // attach click handlers（仅为有效词条绑定）
                        filtered.forEach(u => {
                            const card = document.getElementById('uni-' + u.id);
                            if (card) card.addEventListener('click', () => navigateToUniversity(u.id));
                        });
                    } catch (e) {
                        listEl.innerHTML = '<div class="error" style="grid-column: 1 / -1">加载大学失败</div>';
                    }
                }));

                loading.style.display = 'none';
                moodWrap.style.display = 'block';
            } catch (e) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = '加载失败：' + e.message;
            }
        }

        function sectionHTML(mood) {
            const color = mood.color || '#667eea';
            return `
                <div class="mood-section" id="mood-${mood.id}" style="--mood-color:${color}">
                    <div class="mood-header">
                        <div class="mood-band" style="background:${color}"></div>
                        <div>
                            <div class="mood-title">${mood.name}</div>
                            <div class="mood-desc">${mood.short_desc || ''}</div>
                        </div>
                    </div>
                    <div class="uni-grid"></div>
                </div>
            `;
        }

        function universityCardHTML(u) {
            const logo = u.logo_url || generateLogoSvg(u.name, 56);
            const one = u.one_line || '';
            const likes = (typeof u.like_count === 'number') ? u.like_count : (u.like_count || 0);
            return `
                <div class="uni-card" id="uni-${u.id}" role="button" tabindex="0">
                    <img class="uni-logo" src="${logo}" alt="${u.name}" />
                    <div class="uni-info">
                        <div class="uni-name">${u.name}</div>
                        <div class="uni-one">${one}</div>
                    </div>
                    <div class="uni-like">❤ ${likes}</div>
                </div>
            `;
        }

        function navigateToUniversity(id) {
            const base = window.location.pathname.includes('huilanweb') ? '/huilanweb' : '';
            // 拦截已删除的大学ID
            if (DELETED_UNIVERSITY_IDS.has(id)) {
                alert('该页面已删除：不是学校的内容');
                return;
            }
            // 使用查询参数跳转，避免依赖服务器的重写规则
            window.location.href = `${base}/university.html?id=${id}`;
        }
        // 生成专属LOGO（SVG Data URI）
        function generateLogoSvg(name, size = 56) {
            const initial = (name || 'U').trim().charAt(0);
            let hash = 0;
            for (let i = 0; i < (name || '').length; i++) {
                hash = ((hash << 5) - hash) + name.charCodeAt(i);
                hash |= 0;
            }
            const hue = Math.abs(hash) % 360;
            const bg = `hsl(${hue}, 70%, 55%)`;
            const svg = `<?xml version='1.0' encoding='UTF-8'?>\n<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'>\n  <rect width='${size}' height='${size}' rx='10' fill='${bg}'/>\n  <text x='50%' y='50%' font-size='${Math.round(size*0.55)}' text-anchor='middle' dominant-baseline='middle' fill='#ffffff' font-family='Segoe UI, Microsoft YaHei, Arial'>${initial}</text>\n</svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }
    </script>
    <script src="top-nav.js"></script>
    <script src="site-footer.js"></script>
</body>
</html>