<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å­¦ä¿¡æ¯ - ç»˜æ–“</title>
    <meta name="description" content="å¤§å­¦ä¿¡æ¯é¡µæ¨¡æ¿ï¼ŒåŒ…å«å¤§å­¦åã€åœ°åŒºã€å±‚æ¬¡ã€é‡ç‚¹ä¸“ä¸šä¸æ€§æ ¼æ ‡ç­¾ã€‚">
    <meta name="keywords" content="å¤§å­¦, åœ°åŒº, å±‚æ¬¡, é‡ç‚¹ä¸“ä¸š, æ€§æ ¼æ ‡ç­¾, ç»˜æ–“">
    <link rel="canonical" href="" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="å¤§å­¦ä¿¡æ¯ - ç»˜æ–“" />
    <meta property="og:description" content="å¤§å­¦ä¿¡æ¯é¡µæ¨¡æ¿ï¼ŒåŒ…å«å¤§å­¦åã€åœ°åŒºã€å±‚æ¬¡ã€é‡ç‚¹ä¸“ä¸šä¸æ€§æ ¼æ ‡ç­¾ã€‚" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <meta property="og:site_name" content="ç»˜æ–“" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="å¤§å­¦ä¿¡æ¯ - ç»˜æ–“" />
    <meta name="twitter:description" content="å¤§å­¦ä¿¡æ¯é¡µæ¨¡æ¿ï¼ŒåŒ…å«å¤§å­¦åã€åœ°åŒºã€å±‚æ¬¡ã€é‡ç‚¹ä¸“ä¸šä¸æ€§æ ¼æ ‡ç­¾ã€‚" />
    <meta name="twitter:image" content="" />
    <!-- ç§»é™¤è¿œç¨‹å ä½å›¾é¢„è¿æ¥ï¼Œä½¿ç”¨æœ¬åœ°å ä½å›¾ -->
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f7f8fb; color: #333; margin: 0; }
        .container { max-width: 960px; margin: 0 auto; padding: 20px; }
        .header { background: white; border-bottom: 1px solid #eee; }
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }
        .logo { font-weight: bold; color: #333; text-decoration: none; }
        .card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 1.2rem; display: flex; gap: 1rem; align-items: center; }
        .logo-img { width: 80px; height: 80px; border-radius: 10px; border: 1px solid #eee; object-fit: contain; background: #fafafa; }
        .title { font-size: 1.4rem; font-weight: 600; }
        .one { color: #666; margin-top: .3rem; }
        .like { color: #ff6b6b; margin-top: .3rem; }
        .back { display: inline-block; margin-top: 1rem; color: #667eea; text-decoration: none; }
        .meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .8rem; margin-top: .6rem; color: #555; font-size: .92rem; }
        .badge { display: inline-block; padding: .2rem .5rem; border-radius: 6px; font-size: .85rem; background: #eef3ff; color: #334; border: 1px solid #dde3ff; }
        .section { background: white; border: 1px solid #eee; border-radius: 12px; padding: 1rem; margin-top: 1rem; }
        .section h3 { margin-bottom: .6rem; font-size: 1.1rem; }
        .row { display: flex; gap: .8rem; align-items: center; flex-wrap: wrap; }
        .btn { padding: .5rem .9rem; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
        .btn.primary { background: #667eea; color: #fff; border-color: #667eea; }
        .hint { color: #2d8a48; font-size: .9rem; }
        .error { color: #d63031; font-size: .9rem; }
        .chart { display: grid; grid-template-columns: 1fr; gap: .6rem; }
        .bar { display: grid; grid-template-columns: 160px 1fr 60px; align-items: center; gap: .6rem; }
        .bar-label { font-size: .92rem; color: #333; }
        .bar-track { height: 14px; background: #f1f5f9; border-radius: 8px; overflow: hidden; border: 1px solid #e5e9ef; }
        .bar-fill { height: 100%; background: #667eea; }
        .bar-value { font-size: .9rem; color: #444; text-align: right; }
        /* chips & tags */
        .chips { display: flex; gap: .5rem; flex-wrap: wrap; }
        /* ç®€çº¦é£æ ‡ç­¾ï¼šå‡å°å†…è¾¹è·ï¼Œç™½åº•ã€æµ…è¾¹ï¼Œå¼±åŒ–ç‚¹ç¼€è‰² */
        .chip { display: inline-flex; align-items: center; gap: .28rem; padding: .25rem .55rem; border-radius: 999px; border: 1px solid #e6e8ef; background: #fff; font-size: .85rem; color: #555; }
        .chip .dot { width: 6px; height: 6px; border-radius: 50%; background: #667eea; opacity: .8; }
        .chip.interactive { background: #fff; border-color: #e3e6ef; }
        .chip .like-btn { border: none; background: transparent; cursor: pointer; color: #ff6b6b; font-size: .95rem; line-height: 1; }
        .chip .like-btn.active { color: #e03131; }
        .chip .like-btn[disabled] { cursor: not-allowed; opacity: .6; }
        .chip .count { color: #777; font-size: .8rem; }
        .chip input[type=radio] { cursor: pointer; accent-color: #667eea; }
        .tag-hint { color: #777; font-size: .85rem; margin-top: .4rem; }
        .placeholder { color: #888; font-size: .9rem; }
        /* ç®€ä»‹ä¸å…¥å­¦æ–¹å¼æ ·å¼ */
        .intro-text { color: #555; font-size: .95rem; line-height: 1.7; }
        .admissions-list { margin: 0; padding-left: 1.1rem; color: #444; line-height: 1.7; }
        .admissions-list li { margin: .2rem 0; }
        /* åˆ†äº«å¼¹çª—æ ·å¼ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal .box { background: #fff; border-radius: 12px; border: 1px solid #eee; padding: 1rem; width: min(680px, 92vw); }
        .modal .box h3 { margin-top: 0; }
        .modal .actions { display: flex; gap: .5rem; align-items: center; }
        .modal .preview { display: grid; place-items: center; background: #f7f8fb; border: 1px dashed #e5e9ef; border-radius: 8px; padding: .8rem; }
        .sr { font-size: .9rem; color: #666; }
        @media (max-width: 640px) {
            .card { flex-direction: column; align-items: flex-start; }
            .bar { grid-template-columns: 120px 1fr 40px; }
        }
    </style>
</head>
<body>
    <div id="top-nav"></div>
    <main class="container">
        <div id="loading" style="text-align:center; padding:2rem; color:#666;">
            æ­£åœ¨åŠ è½½å¤§å­¦è¯¦æƒ…...
        </div>
        <div id="error" style="display:none; background:#fdecec; color:#d63031; padding:1rem; border-radius:8px;"></div>
        <div id="detail" style="display:none;"></div>
    </main>

    <script>
        // å·²åˆ é™¤æˆ–éé«˜æ ¡å†…å®¹çš„IDåå•ï¼ˆå¯æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
        const DELETED_UNIVERSITY_IDS = new Set([11, 12]);
        const base = window.location.pathname.includes('huilanweb') ? '/huilanweb' : '';
        const apiBase = base + '/api';

        document.addEventListener('DOMContentLoaded', () => {
            const id = getUniversityIdFromQuery();
            if (!id) {
                showError('æ— æ•ˆçš„å¤§å­¦ID');
                return;
            }
            if (DELETED_UNIVERSITY_IDS.has(id)) {
                showDeletedPageNotice();
                return;
            }
            loadDetail(id);
        });

        function getUniversityIdFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const id = parseInt(params.get('id'), 10);
            return Number.isFinite(id) && id > 0 ? id : null;
        }

        async function loadDetail(id) {
            const loading = document.getElementById('loading');
            const detail = document.getElementById('detail');
            try {
                const res = await fetch(`${apiBase}/universities/${id}`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const u = await res.json();
                loading.style.display = 'none';
                detail.style.display = 'block';
                detail.innerHTML = renderDetail(u);
                window.__currentUniversity = u;
                bindActions(u);
                // æ‰©å±•åŠ è½½ï¼šåŸºç¡€ä¿¡æ¯ä¸æ€§æ ¼æ ‡ç­¾
                await Promise.all([
                    loadBasicInfoByName(u.name),
                    loadIntroByName(u.name),
                    loadAdmissionsByName(u.name)
                ]);
                await loadMbtiByName(u.name, u.mood_type || null);
                // æ›´æ–°SEO
                updateSEO(u);
                // åˆæ¬¡æ³¨å…¥ç»“æ„åŒ–æ•°æ®ï¼ˆä»…ä½¿ç”¨åŸºç¡€å­—æ®µï¼Œç¨åç”±åŸºç¡€ä¿¡æ¯è¡¥å…¨ï¼‰
                injectJSONLD(u, window.__currentBasic || null);
            } catch (e) {
                showError('åŠ è½½å¤±è´¥ï¼š' + e.message);
            }
        }

 function renderDetail(u) {
 const logo = u.logo_url || generateLogoSvg(u.name, 80);
            const likes = (typeof u.like_count === 'number') ? u.like_count : (u.like_count || 0);
            const mood = u.mood_type || {};
            const meta = `
                <div class="meta">
                    <div>çœä»½ï¼š${u.province || '-'}</div>
                    <div>åŸå¸‚ï¼š${u.city || '-'}</div>
                    <div>ç±»å‹ï¼š${u.type || '-'}</div>
                    <div>å…³é”®è¯ï¼š${u.keywords || '-'}</div>
                    <div>æ°”è´¨ï¼š<span class="badge" style="background:${mood.color || '#eef3ff'}33;border-color:${mood.color || '#dde3ff'}">${mood.name || '-'}</span></div>
                </div>`;
            return `
                <div class="card">
  <img class="logo-img" src="${logo}" alt="${u.name}" loading="lazy" width="80" height="80" />
                    <div>
                        <div class="title">${u.name}</div>
                        <div class="one">${u.one_line || ''}</div>
                        ${meta}
                        <div class="row" style="margin-top:.6rem; display:flex; flex-wrap:wrap; gap:.6rem; align-items:center;">
                            <button class="btn" id="likeBtn">æƒ³è¯»</button>
                            <span class="like" id="likeCount" style="min-width:4rem;">â¤ ${likes}</span>
                            <button class="btn" id="studyingBtn">åœ¨è¯»</button>
                            <span class="like" id="studyingCount" style="min-width:4rem;">ğŸ“š 0</span>
                            <span id="actionError" class="error" style="display:none;"></span>
                            <span id="actionHint" class="hint" style="display:none;"></span>
                        </div>
                        <div class="row" style="margin-top:.4rem; display:flex; flex-wrap:wrap; gap:.5rem; align-items:center;">
                            <button class="btn" id="shareCopy">å¤åˆ¶å¡ç‰‡</button>
                            <button class="btn" id="shareImage">ç”Ÿæˆåˆ†äº«å›¾</button>
                            <button class="btn" id="shareWeChat">å¾®ä¿¡åˆ†äº«</button>
                            <button class="btn" id="shareRed">å°çº¢ä¹¦åˆ†äº«</button>
                        </div>
                        <div class="sr" style="margin-top:.3rem; color:#666; font-size:.9rem;">
                            ç”Ÿæˆçš„åˆ†äº«å›¾é€‚ç”¨äºæœ‹å‹åœˆ/ç¬”è®°ï¼Œå¤åˆ¶å¡ç‰‡ä¸ºæ–‡æœ¬/HTML
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>åŸºæœ¬èµ„æ–™</h3>
                    <div class="meta" id="basicMeta">
                        <div>åœ°åŒºï¼š<span id="regionVal">-</span></div>
                        <div>æ€§è´¨ï¼š<span id="natureVal">-</span></div>
                        <div>å±‚æ¬¡ï¼š<span id="levelVal">-</span></div>
                        <div>å®˜ç½‘ï¼š<a id="officialSite" href="#" target="_blank" rel="noopener">-</a></div>
                    </div>
                    <div style="margin-top:.6rem;">
                        <div style="font-weight:600; margin-bottom:.4rem;">é‡ç‚¹ä¸“ä¸š</div>
                        <div id="majorsList" class="chips"><span class="placeholder">åŠ è½½ä¸­...</span></div>
                    </div>
                    <div style="margin-top:.8rem;">
                        <div style="font-weight:600; margin-bottom:.3rem;">å­¦æ ¡ç®€ä»‹</div>
                        <div id="introText" class="intro-text"><span class="placeholder">æ­£åœ¨è¡¥å……ä»‹ç»...</span></div>
                    </div>
                </div>

                <div class="section">
                    <h3>MBTI ç”»åƒ</h3>
                    <div class="meta">
                        <div>ç±»å‹ï¼š<span id="mbtiTypeVal">-</span></div>
                        <div>æ°”è´¨ï¼š<span id="mbtiTemperVal">-</span></div>
                    </div>
                    <div style="margin-top:.6rem; display:grid; grid-template-columns: 140px 1fr; gap:.8rem; align-items:center;">
                        <img id="mbtiIllustration" src="${base}/assets/placeholder.svg" alt="MBTIæ’ç”»" style="width:120px;height:120px;object-fit:contain;border-radius:.6rem;background:#f7f7f7;border:1px solid #eee" />
                        <div>
                            <div style="font-weight:600; margin-bottom:.3rem;">æ°”è´¨æ•…äº‹</div>
                            <div id="mbtiStory" class="intro-text"><span class="placeholder">æ­£åœ¨è¡¥å……æ•…äº‹...</span></div>
                        </div>
                    </div>
                    <div class="sr" style="margin-top:.4rem;">MBTIæ ‡ç­¾ä¸æ•…äº‹åŸºäºå…¬å¼€èµ„æ–™ä¸æ ¡å›­å°è±¡ï¼Œä¾›å‚è€ƒ</div>
                </div>

                <div class="section">
                    <h3>å…¥å­¦æ–¹å¼</h3>
                    <ul id="admissionsList" class="admissions-list"><li class="placeholder">æ­£åœ¨åŠ è½½...</li></ul>
                    <div class="sr" style="margin-top:.4rem;">ä¸åŒé™¢æ ¡ä¸çœä»½æ”¿ç­–å¯èƒ½ä¸åŒï¼Œä»¥å®˜æ–¹æ‹›ç”Ÿç®€ç« ä¸ºå‡†</div>
                </div>


                
                <div class="section" id="seoContent">
                    <h3>å­¦æ ¡å…³é”®è¯ä¸å¸¸è§é—®ç­”</h3>
                    <div id="seoKeywords" class="intro-text"><span class="placeholder">æ­£åœ¨ä¼˜åŒ–å…³é”®è¯...</span></div>
                    <div id="seoLinks" class="intro-text" style="margin-top:.4rem;"><span class="placeholder">æ­£åœ¨ç”Ÿæˆç›¸å…³é“¾æ¥...</span></div>
                    <div id="seoFaq" class="intro-text" style="margin-top:.6rem;"><span class="placeholder">æ­£åœ¨ç”Ÿæˆå¸¸è§é—®é¢˜...</span></div>
                </div>

                <a class="back" href="${base}/mood-map.html">è¿”å›å¤§å­¦å›¾è°±</a>
        `;
    }

        // å·²ç§»é™¤æŠ•ç¥¨åˆ†å¸ƒä¸å‰ç«¯æŠ•ç¥¨äº¤äº’

        // åŠ è½½åŸºç¡€ä¿¡æ¯ï¼ˆuniversities_basicï¼‰
        async function loadBasicInfoByName(name) {
            const regionEl = document.getElementById('regionVal');
            const natureEl = document.getElementById('natureVal');
            const levelEl = document.getElementById('levelVal');
            const siteEl = document.getElementById('officialSite');
            const majorsEl = document.getElementById('majorsList');
            try {
                const res = await fetch(`${apiBase}/universities_basic?q=${encodeURIComponent(name)}`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                const list = (json && json.success && json.data && Array.isArray(json.data.universities)) ? json.data.universities : [];
                const item = list.find(i => i.name === name) || list[0] || null;
                if (!item) {
                    regionEl.textContent = '-';
                    natureEl.textContent = '-';
                    levelEl.textContent = '-';
                    siteEl.textContent = '-';
                    siteEl.setAttribute('href', '#');
                    majorsEl.innerHTML = '<span class="placeholder">æš‚æ— æ•°æ®</span>';
                    window.__currentBasic = null;
                    return;
                }
                regionEl.textContent = item.region || '-';
                natureEl.textContent = item.nature || '-';
                levelEl.textContent = item.level || '-';
                // å°è¯•ä»æœ¬åœ°æ˜ å°„è·å–å®˜ç½‘
                try {
                    const sres = await fetch(`${base}/data/official_sites.json`);
                    if (sres.ok) {
                        const map = await sres.json();
                        const site = (map && (map[name] || map[(name || '').trim()])) || '';
                        if (site) {
                            siteEl.textContent = stripProtocol(site);
                            siteEl.setAttribute('href', site);
                        } else {
                            siteEl.textContent = '-';
                            siteEl.setAttribute('href', '#');
                        }
                    } else {
                        siteEl.textContent = '-';
                        siteEl.setAttribute('href', '#');
                    }
                } catch { siteEl.textContent = '-'; siteEl.setAttribute('href', '#'); }
                const majors = Array.isArray(item.key_majors) ? item.key_majors : [];
                majorsEl.innerHTML = majors.length
                    ? majors.map(m => `<span class="chip"><span class="dot"></span>${escapeHtml(m)}</span>`).join('')
                    : '<span class="placeholder">æš‚æ— æ•°æ®</span>';
                window.__currentBasic = item;
                // ç»“åˆåŸºç¡€ä¿¡æ¯å†æ¬¡æ›´æ–°JSON-LD
                if (window.__currentUniversity) {
                  injectJSONLD(window.__currentUniversity, window.__currentBasic);
                  // åŸºç¡€ä¿¡æ¯å°±ç»ªååˆ·æ–°SEO
                  updateSEO(window.__currentUniversity);
                  updateSEOContent();
                }
            } catch (e) {
                majorsEl.innerHTML = '<span class="placeholder">åŠ è½½å¤±è´¥</span>';
            }
        }

        // åŠ è½½æ€§æ ¼æ ‡ç­¾ï¼ˆuniversity/{id}/tagsï¼‰
        async function loadUniversityTags(uniId) {
            const el = document.getElementById('personalityTags');
            try {
                const res = await fetch(`${apiBase}/university/${uniId}/tags`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                const tags = (json && json.success && json.data && Array.isArray(json.data.tags)) ? json.data.tags : [];
                if (!tags.length) {
                    el.innerHTML = '<span class="placeholder">æš‚æ— æ ‡ç­¾</span>';
                    updateTagStats(uniId, []);
                    return;
                }
                el.innerHTML = tags.map(t => {
                    const liked = isTagLiked(uniId, t.id);
                    const likeCount = typeof t.like_count === 'number' ? t.like_count : 0;
                    return `
                        <span class="chip interactive" data-tag-id="${t.id}">
                            <span class="dot"></span>${escapeHtml(t.tag_name)}
                            <button class="like-btn ${liked ? 'active' : ''}" title="ç‚¹èµè¯¥æ ‡ç­¾" ${liked ? 'disabled' : ''}>â¤</button>
                            <span class="count" title="æ ‡ç­¾çƒ­åº¦">${likeCount}</span>
                        </span>
                    `;
                }).join('');

                // äº‹ä»¶ç»‘å®š
                el.querySelectorAll('.chip.interactive .like-btn').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const chip = ev.currentTarget.closest('.chip.interactive');
                        const tagId = parseInt(chip.getAttribute('data-tag-id'), 10);
                        // è‹¥æœ¬åœ°å·²æ ‡è®°ç‚¹èµï¼Œåˆ™æ— éœ€å†æ¬¡è¯·æ±‚
                        if (isTagLiked(uniId, tagId)) {
                            showActionHint('å·²ç‚¹èµ');
                            return;
                        }
                        ev.currentTarget.disabled = true;
                        try {
                            const clientId = getClientId();
                            const resp = await fetchWithRetry(`${apiBase}/university/${uniId}/tags/${tagId}/like`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ client_id: clientId || undefined })
                            }, 2, 400);
                            if (resp && resp.client_id) setClientId(resp.client_id);
                            // å¹‚ç­‰æç¤ºï¼šå¦‚æœå·²ç‚¹èµè¿‡
                            if (resp && resp.already_liked) showActionHint('å·²ç‚¹èµ');
                            // æœ¬åœ°æ ‡è®°ä¸ºå·²ç‚¹èµï¼ˆä¸æ”¯æŒå–æ¶ˆï¼‰
                            markTagLiked(uniId, tagId);
                            // é‡æ–°åŠ è½½ä»¥åˆ·æ–°çƒ­åº¦ä¸æ’åº
                            await loadUniversityTags(uniId);
                        } catch (e) {
                            showActionError('æ ‡ç­¾ç‚¹èµå¤±è´¥ï¼š' + e.message);
                        } finally {
                            ev.currentTarget.disabled = false;
                        }
                    });
                });

                // å·²ç§»é™¤â€œæœ€ç¬¦åˆâ€å•é€‰äº¤äº’

                updateTagStats(uniId, tags);
            } catch (e) {
                el.innerHTML = '<span class="placeholder">åŠ è½½å¤±è´¥</span>';
                updateTagStats(uniId, []);
            }
        }

        // åŠ è½½å­¦æ ¡ç®€ä»‹ï¼ˆæœ¬åœ°JSONï¼Œå¯æ‰©å±•ä¸ºåå°å­—æ®µï¼‰
        async function loadIntroByName(name) {
            const el = document.getElementById('introText');
            try {
                const res = await fetch(`${base}/data/university_intros.json`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const map = await res.json();
                const intro = map && (map[name] || map[(name || '').trim()]) || '';
                const fallback = (window.__currentUniversity && window.__currentUniversity.one_line) || '';
                const fullText = (intro || fallback || '').trim();
                if (!fullText) {
                    el.innerHTML = '<span class="placeholder">æš‚æ— ä»‹ç»</span>';
                    return;
                }
                const limit = 120; // å­—ç¬¦æˆªæ–­é•¿åº¦
                const isLong = fullText.length > limit;
                const shortText = isLong ? fullText.slice(0, limit) + 'â€¦' : fullText;
                el.innerHTML = `
                    <span class="intro-text" data-full="${escapeHtml(fullText)}" data-short="${escapeHtml(shortText)}">${escapeHtml(shortText)}</span>
                    ${isLong ? '<button class="link-btn" id="introToggle">å±•å¼€</button>' : ''}
                `;
                if (isLong) {
                    const toggle = document.getElementById('introToggle');
                    const span = el.querySelector('.intro-text');
                    let expanded = false;
                    toggle.addEventListener('click', () => {
                        expanded = !expanded;
                        span.textContent = expanded ? span.getAttribute('data-full') : span.getAttribute('data-short');
                        toggle.textContent = expanded ? 'æ”¶èµ·' : 'å±•å¼€';
                    });
                }
            } catch (e) {
                el.innerHTML = '<span class="placeholder">æš‚æ— ä»‹ç»</span>';
            }
        }

        // åŠ è½½å…¥å­¦æ–¹å¼ï¼ˆæœ¬åœ°JSONï¼šé€šç”¨ + å…·ä½“é™¢æ ¡è¦†ç›–ï¼‰
        async function loadAdmissionsByName(name) {
            const el = document.getElementById('admissionsList');
            try {
                const res = await fetch(`${base}/data/admissions_modes.json`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                const modes = (data && (data[name] || data['default'])) || [];
                if (!Array.isArray(modes) || modes.length === 0) {
                    el.innerHTML = '<li class="placeholder">æš‚æ— æ•°æ®</li>';
                    return;
                }
                el.innerHTML = modes.map(m => `<li>${escapeHtml(m)}</li>`).join('');
            } catch (e) {
                el.innerHTML = '<li class="placeholder">åŠ è½½å¤±è´¥</li>';
            }
        }

        // åŠ è½½ MBTI ç”»åƒï¼ˆç±»å‹ã€æ°”è´¨æ•…äº‹ã€æ’ç”»ï¼‰ã€‚ä¼˜å…ˆä½¿ç”¨æœ¬åœ°JSONæ˜ å°„ï¼Œç¼ºå¤±åˆ™å ä½
        async function loadMbtiByName(name, moodType) {
            const typeEl = document.getElementById('mbtiTypeVal');
            const temperEl = document.getElementById('mbtiTemperVal');
            const storyEl = document.getElementById('mbtiStory');
            const illuEl = document.getElementById('mbtiIllustration');
            try {
                if (moodType && moodType.name) {
                    temperEl.textContent = moodType.name;
                }
                const tryLoad = async (path) => {
                    try {
                        const res = await fetch(path);
                        if (!res.ok) return null;
                        const arr = await res.json();
                        if (!Array.isArray(arr)) return null;
                        return arr.find(x => x && (x.university === name || (x.university || '').trim() === (name || '').trim())) || null;
                    } catch { return null; }
                };
                let meta = await tryLoad(`${base}/data/universities_mbti.json`);
                if (!meta) meta = await tryLoad(`${base}/data/universities_mbti_100.json`);
                if (meta) {
                    typeEl.textContent = meta.mbti_type || '-';
                    storyEl.textContent = meta.mbti_desc || 'æš‚æ— æ•…äº‹æè¿°';
                    illuEl.src = `${base}/assets/placeholder.svg`;
                    // MBTIå°±ç»ªååˆ·æ–°SEOä¸FAQç»“æ„åŒ–æ•°æ®
                    if (window.__currentUniversity) {
                        updateSEO(window.__currentUniversity);
                        injectFAQJSONLD(window.__currentUniversity, window.__currentBasic || null);
                        updateSEOContent();
                    }
                } else {
                    typeEl.textContent = '-';
                    storyEl.innerHTML = '<span class="placeholder">æš‚æ— å¯¹åº”MBTIæ ‡ç­¾</span>';
                    illuEl.src = `${base}/assets/placeholder.svg`;
                }
            } catch {
                storyEl.innerHTML = '<span class="placeholder">åŠ è½½å¤±è´¥</span>';
                illuEl.src = `${base}/assets/placeholder.svg`;
            }
        }

        function updateTagStats(uniId, tags) {
            const statsEl = document.getElementById('tagStats');
            const likedIds = getLikedTagIds(uniId);
            const likeTotal = likedIds.length;
            statsEl.textContent = `ç»Ÿè®¡ï¼šæœ¬è®¾å¤‡ â€” å·²ç‚¹èµ ${likeTotal}`;
        }

        // åŒ¿åäº¤äº’å­˜å‚¨ï¼ˆlocalStorageï¼‰
        function getLikedTagIds(uniId) {
            try {
                const raw = localStorage.getItem('hj_ut_likes:' + uniId);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch { return []; }
        }
        function setLikedTagIds(uniId, arr) {
            try { localStorage.setItem('hj_ut_likes:' + uniId, JSON.stringify(arr)); } catch {}
        }
        function isTagLiked(uniId, tagId) {
            const arr = getLikedTagIds(uniId);
            return arr.includes(tagId);
        }
        function markTagLiked(uniId, tagId) {
            const arr = getLikedTagIds(uniId);
            if (!arr.includes(tagId)) {
                arr.push(tagId);
                setLikedTagIds(uniId, arr);
            }
        }
        // å·²ç§»é™¤â€œæœ€ç¬¦åˆâ€è®°å½•é€»è¾‘

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
        }
        // å®‰å…¨ç§»é™¤ URL åè®®å‰ç¼€ï¼Œé¿å…ä½¿ç”¨æ­£åˆ™å¯¼è‡´çš„è§£æé—®é¢˜
        function stripProtocol(url) {
            const s = String(url || '');
            if (s.startsWith('https://')) return s.slice(8);
            if (s.startsWith('http://')) return s.slice(7);
            return s;
        }

        // ç”Ÿæˆä¸“å±LOGOï¼ˆSVG Data URIï¼‰
        function generateLogoSvg(name, size = 80) {
            const initial = (name || 'U').trim().charAt(0);
            let hash = 0;
            for (let i = 0; i < (name || '').length; i++) {
                hash = ((hash << 5) - hash) + name.charCodeAt(i);
                hash |= 0;
            }
            const hue = Math.abs(hash) % 360;
            const bg = `hsl(${hue}, 70%, 55%)`;
            const svg = `<?xml version='1.0' encoding='UTF-8'?>\n<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'>\n  <rect width='${size}' height='${size}' rx='10' fill='${bg}'/>\n  <text x='50%' y='50%' font-size='${Math.round(size*0.55)}' text-anchor='middle' dominant-baseline='middle' fill='#ffffff' font-family='Segoe UI, Microsoft YaHei, Arial'>${initial}</text>\n</svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        // æ›´æ–°SEOï¼ˆTitle/Description/Keywords/OG/Twitter/Canonicalï¼‰
        function updateSEO(u) {
            const basePath = (window.location.pathname.includes('huilanweb') ? '/huilanweb' : '');
            const url = window.location.origin + basePath + `/university/${u.id}`;
            const basic = window.__currentBasic || {};
            const mbtiType = (document.getElementById('mbtiTypeVal')?.textContent || '').trim();
            const moodName = (u.mood_type && u.mood_type.name) ? u.mood_type.name : '';
            const majors = Array.isArray(basic.key_majors) ? basic.key_majors : [];

            const title = `${u.name} ${basic.level ? `(${basic.level})` : ''} - å¤§å­¦ä¿¡æ¯ | ç»˜æ–“`.trim();
            const descParts = [
                u.one_line || `${u.name} åŸºæœ¬ä¿¡æ¯`,
                `åœ°åŒºï¼š${basic.region || u.province || '-'}`,
                `æ€§è´¨ï¼š${basic.nature || u.type || '-'}`,
                `å±‚æ¬¡ï¼š${basic.level || '-'}`,
                `é‡ç‚¹ä¸“ä¸šï¼š${majors.slice(0, 4).join('ã€') || '-'}`,
                moodName ? `æ°”è´¨ï¼š${moodName}` : '',
                mbtiType ? `MBTIï¼š${mbtiType}` : ''
            ].filter(Boolean);
            const desc = descParts.join('ï¼›');

            const img = u.logo_url || generateLogoSvg(u.name, 630);

            document.title = title;
            setMeta('description', desc);
            // å…³é”®è¯ç»„åˆï¼šå»é‡å¹¶é™åˆ¶é•¿åº¦
            const kwSet = new Set([
                u.name,
                'å¤§å­¦', 'é™¢æ ¡',
                basic.region || u.province || '',
                u.city || '',
                basic.nature || u.type || '',
                basic.level || '',
                ...((u.keywords || '').split('|').filter(Boolean)),
                ...majors.slice(0, 6),
                moodName || '',
                mbtiType || ''
            ].filter(Boolean).map(s => (s || '').trim()));
            const keywords = Array.from(kwSet).slice(0, 12).join(',');
            setMeta('keywords', keywords);

            setOG('og:type', 'article');
            setOG('og:title', title);
            setOG('og:description', desc);
            setOG('og:url', url);
            setOG('og:image', img);
            setOG('og:site_name', 'ç»˜æ–“');

            setMeta('twitter:card', 'summary_large_image');
            setMeta('twitter:title', title);
            setMeta('twitter:description', desc);
            setMeta('twitter:image', img);

            setCanonical(url);
        }
        function setMeta(name, content) {
            let el = document.querySelector(`meta[name="${name}"]`);
            if (!el) {
                el = document.createElement('meta');
                el.setAttribute('name', name);
                document.head.appendChild(el);
            }
            el.setAttribute('content', content);
        }
        function setOG(property, content) {
            let el = document.querySelector(`meta[property="${property}"]`);
            if (!el) {
                el = document.createElement('meta');
                el.setAttribute('property', property);
                document.head.appendChild(el);
            }
            el.setAttribute('content', content);
        }
        function setCanonical(url) {
            let link = document.querySelector('link[rel="canonical"]');
            if (!link) {
                link = document.createElement('link');
                link.setAttribute('rel', 'canonical');
                document.head.appendChild(link);
            }
            link.setAttribute('href', url);
        }

        // æ³¨å…¥ Schema.org JSON-LDï¼ˆCollegeOrUniversity ä¸ BreadcrumbListï¼‰
        function injectJSONLD(u, basic) {
            if (!u || !u.id) return;
            const basePath = (window.location.pathname.includes('huilanweb') ? '/huilanweb' : '');
            const url = window.location.origin + basePath + `/university/${u.id}`;
            const logo = u.logo_url || 'https://via.placeholder.com/600x315?text=UNI';
            const region = basic && basic.region ? basic.region : (u.province || '');
            const level = basic && basic.level ? basic.level : '';
            const majors = (basic && Array.isArray(basic.key_majors)) ? basic.key_majors : [];
            const nature = basic && basic.nature ? basic.nature : (u.type || '');

            const college = {
                '@context': 'https://schema.org',
                '@type': 'CollegeOrUniversity',
                'name': u.name,
                'url': url,
                'logo': logo,
                'address': region ? { '@type': 'PostalAddress', 'addressRegion': region } : undefined,
                'description': u.one_line || undefined,
                'sameAs': [],
                'founder': undefined,
                'keywords': (u.keywords || '').split('|').filter(Boolean),
                'additionalType': nature || undefined,
                'educationalCredentialAwarded': level || undefined,
                'department': majors.length ? majors.map(m => ({ '@type': 'EducationalOrganization', 'name': m })) : undefined
            };

            const breadcrumb = {
                '@context': 'https://schema.org',
                '@type': 'BreadcrumbList',
                'itemListElement': [
                    {
                        '@type': 'ListItem',
                        'position': 1,
                        'name': 'é¦–é¡µ',
                        'item': window.location.origin + basePath + '/index.html'
                    },
                    {
                        '@type': 'ListItem',
                        'position': 2,
                        'name': 'å¤§å­¦',
                        'item': window.location.origin + basePath + '/search.html'
                    },
                    {
                        '@type': 'ListItem',
                        'position': 3,
                        'name': u.name,
                        'item': url
                    }
                ]
            };

            setJSONLD('ld-university', college);
            setJSONLD('ld-breadcrumb', breadcrumb);
            // FAQç»“æ„åŒ–æ•°æ®
            injectFAQJSONLD(u, basic);
        }

        function setJSONLD(id, obj) {
            if (!obj) return;
            let el = document.getElementById(id);
            if (!el) {
                el = document.createElement('script');
                el.type = 'application/ld+json';
                el.id = id;
                document.head.appendChild(el);
            }
            el.textContent = JSON.stringify(obj);
        }

        // FAQPage JSON-LD
        function injectFAQJSONLD(u, basic) {
            const site = document.getElementById('officialSite')?.getAttribute('href') || '';
            const majors = (basic && Array.isArray(basic.key_majors)) ? basic.key_majors : [];
            const mbtiType = (document.getElementById('mbtiTypeVal')?.textContent || '').trim();
            const moodName = (u.mood_type && u.mood_type.name) ? u.mood_type.name : '';
            const faq = {
                '@context': 'https://schema.org',
                '@type': 'FAQPage',
                'mainEntity': [
                    {
                        '@type': 'Question',
                        'name': `${u.name}æœ‰å“ªäº›é‡ç‚¹ä¸“ä¸šï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': majors.length ? majors.join('ã€') : 'æš‚æ— é‡ç‚¹ä¸“ä¸šä¿¡æ¯' }
                    },
                    {
                        '@type': 'Question',
                        'name': `${u.name}é€‚åˆä»€ä¹ˆæ ·çš„æ€§æ ¼æˆ–MBTIç±»å‹ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': [moodName ? `æ°”è´¨ï¼š${moodName}` : '', mbtiType ? `MBTIï¼š${mbtiType}` : ''].filter(Boolean).join('ï¼›') || 'æš‚æ— ç”»åƒä¿¡æ¯' }
                    },
                    {
                        '@type': 'Question',
                        'name': `${u.name}å±äºä»€ä¹ˆå±‚æ¬¡åŠåŠå­¦æ€§è´¨ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': `å±‚æ¬¡ï¼š${basic?.level || '-'}ï¼›æ€§è´¨ï¼š${basic?.nature || u.type || '-'}` }
                    },
                    {
                        '@type': 'Question',
                        'name': `å¦‚ä½•æŸ¥çœ‹${u.name}çš„å®˜ç½‘ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': site ? `å®˜ç½‘åœ°å€ï¼š${site}` : 'æš‚æ— å®˜ç½‘åœ°å€' }
                    },
                    {
                        '@type': 'Question',
                        'name': `${u.name}è¿‘å¹´å½•å–åˆ†æ•°çº¿å¦‚ä½•ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': 'åˆ†çœåˆ†æ‰¹æ¬¡å·®å¼‚è¾ƒå¤§ï¼Œè¯·ä»¥çœçº§æ‹›è€ƒä¿¡æ¯ä¸å­¦æ ¡æ‹›ç”Ÿç®€ç« ä¸ºå‡†ã€‚' }
                    },
                    {
                        '@type': 'Question',
                        'name': `${u.name}ä½å®¿æ¡ä»¶æ€ä¹ˆæ ·ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': 'å®¿èˆæ¡ä»¶ä»¥å­¦æ ¡åå‹¤ä¸å­¦é™¢å®‰æ’ä¸ºå‡†ï¼Œå»ºè®®æŸ¥çœ‹å®˜ç½‘çš„æ–°ç”ŸæŒ‡å—æˆ–åå‹¤å…¬å‘Šã€‚' }
                    },
                    {
                        '@type': 'Question',
                        'name': `${u.name}å¥–å­¦é‡‘è®¾ç½®æœ‰å“ªäº›ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': 'é€šå¸¸è®¾æœ‰å›½å®¶/æ ¡çº§/å­¦é™¢å¥–åŠ©å­¦é‡‘ï¼Œå…·ä½“æ ‡å‡†ä¸ç”³è¯·æ¡ä»¶ä»¥å­¦æ ¡å®˜ç½‘å‘å¸ƒä¸ºå‡†ã€‚' }
                    },
                    {
                        '@type': 'Question',
                        'name': `${u.name}æ˜¯å¦æœ‰å›½é™…åˆä½œä¸äº¤æµé¡¹ç›®ï¼Ÿ`,
                        'acceptedAnswer': { '@type': 'Answer', 'text': 'å¤šæ•°é«˜æ ¡ä¸å¢ƒå†…å¤–é«˜æ ¡/ä¼ä¸šè®¾æœ‰åˆä½œäº¤æµé¡¹ç›®ï¼Œè¯·æŸ¥è¯¢å›½é™…åˆä½œä¸äº¤æµåŠå…¬å®¤æˆ–å­¦é™¢é€šçŸ¥ã€‚' }
                    }
                ]
            };
            setJSONLD('ld-faq', faq);
        }

        // å…³é”®è¯æ®µä¸FAQå¯è¯»å†…å®¹ï¼ˆå†…å®¹åŸ‹è¯ï¼‰
        function updateSEOContent() {
            const u = window.__currentUniversity || {};
            const b = window.__currentBasic || {};
            const majors = Array.isArray(b.key_majors) ? b.key_majors : [];
            const moodName = (u.mood_type && u.mood_type.name) ? u.mood_type.name : '';
            const mbtiType = (document.getElementById('mbtiTypeVal')?.textContent || '').trim();

            const kwEl = document.getElementById('seoKeywords');
            const linksEl = document.getElementById('seoLinks');
            const faqEl = document.getElementById('seoFaq');
            if (!kwEl || !linksEl || !faqEl) return;

            const kwText = [
                `${u.name}ï¼ˆ${b.region || u.province || '-'}ï¼Œ${b.level || '-'}ï¼Œ${b.nature || u.type || '-' }ï¼‰`,
                `é‡ç‚¹ä¸“ä¸šï¼š${majors.slice(0,6).join('ã€') || '-'}`,
                moodName ? `æ°”è´¨ç”»åƒï¼š${moodName}` : '',
                mbtiType ? `MBTIåŒ¹é…ï¼š${mbtiType}` : ''
            ].filter(Boolean).join('ï¼›');
            kwEl.textContent = kwText || `${u.name} åŸºæœ¬ä¿¡æ¯ä¸å…³é”®è¯`;

            const base = (window.location.pathname.includes('huilanweb') ? '/huilanweb' : '');
            const linksHtml = `
                ç›¸å…³é¡µé¢ï¼š
                <a href="${base}/leaderboard.html" rel="internal">æ ¡å›­äººæ ¼æ¦œå•</a> Â· 
                <a href="${base}/mood-map.html" rel="internal">å¤§å­¦å›¾è°±</a> Â· 
                <a href="${base}/search.html" rel="internal">é«˜æ ¡æœç´¢</a>
            `;
            linksEl.innerHTML = linksHtml;

            const site = document.getElementById('officialSite')?.getAttribute('href') || '';
            const faqHtml = `
                <div style="line-height:1.8;">
                    <div><strong>Qï¼š</strong>${u.name}æœ‰å“ªäº›é‡ç‚¹ä¸“ä¸šï¼Ÿ<br/><strong>Aï¼š</strong>${majors.length ? majors.join('ã€') : 'æš‚æ— é‡ç‚¹ä¸“ä¸šä¿¡æ¯'}</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>${u.name}é€‚åˆä»€ä¹ˆæ ·çš„æ€§æ ¼æˆ–MBTIç±»å‹ï¼Ÿ<br/><strong>Aï¼š</strong>${[moodName ? `æ°”è´¨ï¼š${moodName}` : '', mbtiType ? `MBTIï¼š${mbtiType}` : ''].filter(Boolean).join('ï¼›') || 'æš‚æ— ç”»åƒä¿¡æ¯'}</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>${u.name}å±äºä»€ä¹ˆå±‚æ¬¡åŠåŠå­¦æ€§è´¨ï¼Ÿ<br/><strong>Aï¼š</strong>å±‚æ¬¡ï¼š${b.level || '-'}ï¼›æ€§è´¨ï¼š${b.nature || u.type || '-'}</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>å¦‚ä½•æŸ¥çœ‹${u.name}çš„å®˜ç½‘ï¼Ÿ<br/><strong>Aï¼š</strong>${site ? `<a href="${site}" target="_blank" rel="noopener">${stripProtocol(site)}</a>` : 'æš‚æ— å®˜ç½‘åœ°å€'}</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>${u.name}è¿‘å¹´å½•å–åˆ†æ•°çº¿å¦‚ä½•ï¼Ÿ<br/><strong>Aï¼š</strong>åˆ†çœåˆ†æ‰¹æ¬¡å·®å¼‚è¾ƒå¤§ï¼Œè¯·ä»¥çœçº§æ‹›è€ƒä¿¡æ¯ä¸å­¦æ ¡æ‹›ç”Ÿç®€ç« ä¸ºå‡†ã€‚</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>${u.name}ä½å®¿æ¡ä»¶æ€ä¹ˆæ ·ï¼Ÿ<br/><strong>Aï¼š</strong>å®¿èˆæ¡ä»¶ä»¥å­¦æ ¡åå‹¤ä¸å­¦é™¢å®‰æ’ä¸ºå‡†ï¼Œå»ºè®®æŸ¥çœ‹å®˜ç½‘çš„æ–°ç”ŸæŒ‡å—æˆ–åå‹¤å…¬å‘Šã€‚</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>${u.name}å¥–å­¦é‡‘è®¾ç½®æœ‰å“ªäº›ï¼Ÿ<br/><strong>Aï¼š</strong>é€šå¸¸è®¾æœ‰å›½å®¶/æ ¡çº§/å­¦é™¢å¥–åŠ©å­¦é‡‘ï¼Œå…·ä½“æ ‡å‡†ä¸ç”³è¯·æ¡ä»¶ä»¥å­¦æ ¡å®˜ç½‘å‘å¸ƒä¸ºå‡†ã€‚</div>
                    <div style="margin-top:.4rem;"><strong>Qï¼š</strong>${u.name}æ˜¯å¦æœ‰å›½é™…åˆä½œä¸äº¤æµé¡¹ç›®ï¼Ÿ<br/><strong>Aï¼š</strong>å¤šæ•°é«˜æ ¡ä¸å¢ƒå†…å¤–é«˜æ ¡/ä¼ä¸šè®¾æœ‰åˆä½œäº¤æµé¡¹ç›®ï¼Œè¯·æŸ¥è¯¢å›½é™…åˆä½œä¸äº¤æµåŠå…¬å®¤æˆ–å­¦é™¢é€šçŸ¥ã€‚</div>
                </div>
            `;
            faqEl.innerHTML = faqHtml;
        }

        // åˆ†äº«ï¼šå¤åˆ¶å¡ç‰‡ï¼ˆæ–‡æœ¬+HTMLï¼‰
        function doCopyCard() {
            const u = window.__currentUniversity || {};
            const b = window.__currentBasic || {};
            const mood = u.mood_type || {};
            const majors = Array.isArray(b.key_majors) ? b.key_majors.join('ã€') : '-';
            const url = window.location.origin + (window.location.pathname.includes('huilanweb') ? '/huilanweb' : '') + `/university/${u.id}`;
            const text = [
                `${u.name}`,
                `ä¸€å¥è¯ï¼š${u.one_line || '-'}`,
                `åœ°åŒºï¼š${b.region || u.province || '-'}  ç±»å‹ï¼š${u.type || '-'}`,
                `å±‚æ¬¡ï¼š${b.level || '-'}`,
                `é‡ç‚¹ä¸“ä¸šï¼š${majors}`,
                `æ°”è´¨ï¼š${mood.name || '-'}`,
                `é“¾æ¥ï¼š${url}`
            ].join('\n');

            const html = `
                <div class="card" style="font-family:Arial,sans-serif;max-width:560px;border:1px solid #eee;border-radius:12px;padding:12px;">
                  <div style="display:flex;gap:10px;align-items:center;">
                    <img src="${u.logo_url || (base + '/assets/placeholder.svg')}" alt="${escapeHtml(u.name)}" style="width:80px;height:80px;border-radius:10px;border:1px solid #eee;object-fit:contain;" />
                    <div>
                      <div style="font-size:18px;font-weight:600;">${escapeHtml(u.name)}</div>
                      <div style="color:#666;margin-top:4px;">${escapeHtml(u.one_line || '')}</div>
                    </div>
                  </div>
                  <div style="margin-top:8px;color:#555;font-size:14px;">
                    åœ°åŒºï¼š${escapeHtml(b.region || u.province || '-')}&nbsp;|&nbsp;ç±»å‹ï¼š${escapeHtml(u.type || '-')}&nbsp;|&nbsp;å±‚æ¬¡ï¼š${escapeHtml(b.level || '-')}
                  </div>
                  <div style="margin-top:4px;color:#555;font-size:14px;">é‡ç‚¹ä¸“ä¸šï¼š${escapeHtml(majors)}</div>
                  <div style="margin-top:4px;color:#555;font-size:14px;">æ°”è´¨ï¼š${escapeHtml(mood.name || '-')}</div>
                  <a href="${url}" style="display:inline-block;margin-top:8px;color:#667eea;">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>`;

            if (navigator.clipboard && navigator.clipboard.write) {
                const blobText = new Blob([text], { type: 'text/plain' });
                const blobHtml = new Blob([html], { type: 'text/html' });
                const data = [new ClipboardItem({ 'text/plain': blobText, 'text/html': blobHtml })];
                navigator.clipboard.write(data).then(() => {
                    alert('å·²å¤åˆ¶å¡ç‰‡ï¼ˆæ–‡æœ¬ä¸HTMLï¼‰');
                }).catch(() => {
                    navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶å¡ç‰‡æ–‡æœ¬'));
                });
            } else {
                navigator.clipboard?.writeText(text);
                alert('å·²å¤åˆ¶å¡ç‰‡æ–‡æœ¬');
            }
        }

        // åˆ†äº«ï¼šç”Ÿæˆåˆ†äº«å›¾ï¼ˆOG 1200x630ï¼‰
        function doGenerateShareImage() {
            const u = window.__currentUniversity || {};
            const b = window.__currentBasic || {};
            const mood = u.mood_type || {};
            const majors = Array.isArray(b.key_majors) ? b.key_majors.slice(0, 4).join('ã€') : '-';
            const W = 1200, H = 630;
            const canvas = document.createElement('canvas');
            canvas.width = W; canvas.height = H;
            const ctx = canvas.getContext('2d');

            const grd = ctx.createLinearGradient(0,0,0,H);
            grd.addColorStop(0, '#f9fbff');
            grd.addColorStop(1, '#eef3ff');
            ctx.fillStyle = grd;
            ctx.fillRect(0,0,W,H);

            ctx.fillStyle = '#222';
            ctx.font = 'bold 48px Arial';
            ctx.fillText(u.name || 'å¤§å­¦', 40, 100);

            ctx.font = '24px Arial';
            ctx.fillStyle = '#444';
            ctx.fillText((u.one_line || '').slice(0, 30), 40, 150);

            ctx.font = '22px Arial';
            ctx.fillText(`åœ°åŒºï¼š${b.region || u.province || '-'}`, 40, 210);
            ctx.fillText(`ç±»å‹ï¼š${u.type || '-'}`, 40, 250);
            ctx.fillText(`å±‚æ¬¡ï¼š${b.level || '-'}`, 40, 290);
            ctx.fillText(`é‡ç‚¹ä¸“ä¸šï¼š${majors}`, 40, 330);
            ctx.fillText(`æ°”è´¨ï¼š${mood.name || '-'}`, 40, 370);

            const logo = new Image();
            logo.crossOrigin = 'anonymous';
            logo.onload = () => {
                ctx.drawImage(logo, W-200, 60, 140, 140);
                finalize();
            };
            logo.onerror = finalize;
            logo.src = u.logo_url || generateLogoSvg(u.name, 140);

            function finalize() {
                ctx.font = '18px Arial';
                ctx.fillStyle = '#667eea';
                ctx.fillText('ç»˜æ–“ Huilan', 40, H-40);
                const url = canvas.toDataURL('image/png');
                showShareModal({ title: 'åˆ†äº«å›¾å·²ç”Ÿæˆ', imgUrl: url });
            }
        }

        // åˆ†äº«ï¼šå¾®ä¿¡ï¼ˆäºŒç»´ç +æç¤ºï¼‰
        function doWeChatShare() {
            const u = window.__currentUniversity || {};
            const url = window.location.origin + (window.location.pathname.includes('huilanweb') ? '/huilanweb' : '') + `/university/${u.id}`;
            const qr = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(url)}`;
            showShareModal({ title: 'å¾®ä¿¡åˆ†äº«', html: `<div class=\"preview\"><img src=\"${qr}\" alt=\"äºŒç»´ç \" width=\"240\" height=\"240\" /></div><div class=\"sr\">ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«æ‰“å¼€é¡µé¢ï¼Œç„¶åç‚¹å‡»å³ä¸Šè§’åˆ†äº«</div>` });
        }

        // åˆ†äº«ï¼šå°çº¢ä¹¦ï¼ˆåˆ†äº«æ–‡æ¡ˆä¸å›¾ç‰‡ï¼‰
        function doRedShare() {
            const u = window.__currentUniversity || {};
            const b = window.__currentBasic || {};
            const mood = u.mood_type || {};
            const majors = Array.isArray(b.key_majors) ? b.key_majors.slice(0, 4).join('ã€') : '-';
            const text = `#å¤§å­¦æ¨è #é«˜æ ¡ä¿¡æ¯\n${u.name}\nåœ°åŒºï¼š${b.region || u.province || '-'} ç±»å‹ï¼š${u.type || '-'} å±‚æ¬¡ï¼š${b.level || '-'}\né‡ç‚¹ä¸“ä¸šï¼š${majors}\næ°”è´¨ï¼š${mood.name || '-'}`;
            if (navigator.clipboard?.writeText) navigator.clipboard.writeText(text);
            doGenerateShareImage();
            alert('å·²å¤åˆ¶åˆ†äº«æ–‡æ¡ˆï¼Œå¯åœ¨å°çº¢ä¹¦ç²˜è´´ï¼›å·²ç”Ÿæˆåˆ†äº«å›¾å¯ä¸‹è½½');
        }

        // é€šç”¨åˆ†äº«å¼¹çª—
        function showShareModal(opts) {
            let modal = document.getElementById('shareModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'shareModal';
                modal.className = 'modal';
                modal.innerHTML = `<div class=\"box\"><h3 id=\"shareTitle\"></h3><div id=\"shareBody\"></div><div class=\"actions\" style=\"margin-top:.6rem;\"><button class=\"btn\" id=\"shareClose\">å…³é—­</button><a class=\"btn primary\" id=\"shareDownload\" href=\"#\" download=\"share.png\" style=\"display:none;\">ä¸‹è½½åˆ†äº«å›¾</a></div></div>`;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => { if (e.target === modal) hideShareModal(); });
                document.getElementById('shareClose').addEventListener('click', hideShareModal);
            }
            document.getElementById('shareTitle').textContent = opts.title || 'åˆ†äº«';
            const body = document.getElementById('shareBody');
            if (opts.imgUrl) {
                body.innerHTML = `<div class=\"preview\"><img src=\"${opts.imgUrl}\" alt=\"åˆ†äº«å›¾\" style=\"max-width:100%;height:auto;border-radius:8px;\" /></div>`;
                const dl = document.getElementById('shareDownload');
                dl.style.display = 'inline-block';
                dl.setAttribute('href', opts.imgUrl);
            } else if (opts.html) {
                body.innerHTML = opts.html;
                document.getElementById('shareDownload').style.display = 'none';
            } else {
                body.textContent = 'å°±ç»ª';
                document.getElementById('shareDownload').style.display = 'none';
            }
            modal.style.display = 'flex';
        }
        function hideShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) modal.style.display = 'none';
        }

        function bindActions(u) {
            const likeBtn = document.getElementById('likeBtn');
            const studyingBtn = document.getElementById('studyingBtn');
            const actionError = document.getElementById('actionError');
            const actionHint = document.getElementById('actionHint');
            window.__currentUniversity = u;

            likeBtn.addEventListener('click', async () => {
                actionError.style.display = 'none';
                actionHint.style.display = 'none';
                try {
                    likeBtn.disabled = true;
                    const clientId = getClientId();
                    const json = await fetchWithRetry(`${apiBase}/universities/${u.id}/like`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ client_id: clientId || undefined })
                    }, 2, 400);
                    if (json.client_id) setClientId(json.client_id);
                    document.getElementById('likeCount').textContent = 'â¤ ' + (json.like_count ?? (u.like_count || 0));
                    if (json.already_liked) {
                        actionHint.textContent = 'å·²æƒ³è¯»';
                        actionHint.style.display = 'inline';
                        setTimeout(() => actionHint.style.display = 'none', 1500);
                    }
                } catch (e) {
                    actionError.textContent = 'æƒ³è¯»å¤±è´¥ï¼š' + e.message;
                    actionError.style.display = 'inline';
                } finally {
                    likeBtn.disabled = false;
                }
            });

            // åœ¨è¯»ï¼šåç«¯æŒä¹…åŒ– + ç»Ÿè®¡
            const updateStudyingUI = (count, isStudying) => {
                document.getElementById('studyingCount').textContent = 'ğŸ“š ' + (count ?? 0);
                studyingBtn.classList.toggle('primary', !!isStudying);
                studyingBtn.textContent = isStudying ? 'åœ¨è¯»ä¸­' : 'åœ¨è¯»';
            };

            // åˆæ¬¡æ‹‰å–åœ¨è¯»ç»Ÿè®¡ä¸çŠ¶æ€
            (async () => {
                try {
                    const stats = await fetchWithRetry(`${apiBase}/universities/${u.id}/studying`, { credentials: 'include' }, 1, 300);
                    if (stats && stats.success && stats.data) {
                        updateStudyingUI(stats.data.studying_count, stats.data.is_studying);
                    }
                } catch { /* é™é»˜å¤±è´¥ï¼šä¿æŒé»˜è®¤æ˜¾ç¤º */ }
            })();

            studyingBtn.addEventListener('click', async () => {
                actionError.style.display = 'none';
                actionHint.style.display = 'none';
                try {
                    studyingBtn.disabled = true;
                    const currentIsStudying = studyingBtn.classList.contains('primary');
                    const next = !currentIsStudying;
                    const clientId = getClientId();
                    const json = await fetchWithRetry(`${apiBase}/universities/${u.id}/studying`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ client_id: clientId || undefined, studying: next })
                    }, 2, 400);
                    if (json.client_id) setClientId(json.client_id);
                    updateStudyingUI(json.studying_count, json.is_studying);
                    actionHint.textContent = next ? 'å·²æ ‡è®°ä¸ºåœ¨è¯»' : 'å·²å–æ¶ˆåœ¨è¯»';
                    actionHint.style.display = 'inline';
                    setTimeout(() => actionHint.style.display = 'none', 1500);
                } catch (e) {
                    actionError.textContent = 'åœ¨è¯»æ ‡è®°å¤±è´¥ï¼š' + e.message;
                    actionError.style.display = 'inline';
                } finally {
                    studyingBtn.disabled = false;
                }
            });

            // å·²ç§»é™¤æŠ•ç¥¨äº¤äº’ï¼ˆmoodSelect ä¸æŠ•ç¥¨åˆ†å¸ƒæ›´æ–°ï¼‰

            // åˆ†äº«æŒ‰é’®ç»‘å®š
            document.getElementById('shareCopy').addEventListener('click', () => doCopyCard());
            document.getElementById('shareImage').addEventListener('click', () => doGenerateShareImage());
            document.getElementById('shareWeChat').addEventListener('click', () => doWeChatShare());
            document.getElementById('shareRed').addEventListener('click', () => doRedShare());
        }

        function slugToName(slug) {
            const map = {
                rational_creator: 'ç†æ€§åˆ›é€ å‹',
                artistic_explorer: 'æ–‡è‰ºæ¢ç´¢å‹',
                social_connector: 'ç¤¾äº¤é¢†å¯¼å‹',
                practical_achiever: 'åŠ¡å®åº”ç”¨å‹'
            };
            return map[slug] || slug;
        }

        function getClientId() {
            try {
                const pairs = document.cookie.split(';');
                for (const raw of pairs) {
                    const idx = raw.indexOf('=');
                    const key = (idx >= 0 ? raw.slice(0, idx) : raw).trim();
                    if (key === 'hj_client_id') {
                        const val = idx >= 0 ? raw.slice(idx + 1) : '';
                        return decodeURIComponent(val || '');
                    }
                }
            } catch {}
            return null;
        }
        function setClientId(id) {
            const maxAge = 30 * 24 * 60 * 60; // 30å¤©
            document.cookie = `hj_client_id=${encodeURIComponent(id)}; path=/; max-age=${maxAge}`;
        }

        // é€šç”¨ç½‘ç»œé‡è¯•å·¥å…·
        async function fetchWithRetry(url, options = {}, retries = 2, backoffMs = 300) {
            let lastErr;
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const res = await fetch(url, options);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return await res.json();
                } catch (e) {
                    lastErr = e;
                    if (attempt < retries) {
                        await new Promise(r => setTimeout(r, backoffMs));
                        continue;
                    }
                    throw lastErr;
                }
            }
        }

        // ç»Ÿä¸€çŸ­æç¤ºä¸é”™è¯¯æç¤ºï¼ˆå¤ç”¨ç°æœ‰ actionHint/actionErrorï¼‰
        function showActionHint(msg) {
            const el = document.getElementById('actionHint');
            if (!el) return;
            el.textContent = msg;
            el.style.display = 'inline';
            setTimeout(() => el.style.display = 'none', 1500);
        }
        function showActionError(msg) {
            const el = document.getElementById('actionError');
            if (!el) return;
            el.textContent = msg;
            el.style.display = 'inline';
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            const error = document.getElementById('error');
            error.style.display = 'block';
            error.textContent = msg;
        }

        // å½“è¯·æ±‚çš„IDå±äºâ€œå·²åˆ é™¤/éé«˜æ ¡å†…å®¹â€æ—¶ï¼Œæ˜¾ç¤ºæç¤ºå¹¶æä¾›è¿”å›å…¥å£
        function showDeletedPageNotice() {
            const loading = document.getElementById('loading');
            const detail = document.getElementById('detail');
            const error = document.getElementById('error');
            loading.style.display = 'none';
            detail.style.display = 'none';
            error.style.display = 'block';
            error.innerHTML = 'è¯¥é¡µé¢å·²åˆ é™¤ï¼šä¸æ˜¯å­¦æ ¡çš„å†…å®¹ã€‚<br/><a class="back" href="' + base + '/search.html">è¿”å›æœç´¢</a> æˆ– <a class="back" href="' + base + '/mood-map.html">è¿”å›å¤§å­¦å›¾è°±</a>';
        }
    </script>
    <div id="site-footer"></div>
    <script src="site-footer.js"></script>
    <script src="top-nav.js"></script>
</body>
</html>